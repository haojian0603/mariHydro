# MariHydro ç³»ç»Ÿæ¶æ„é‡æ„è®¡åˆ’

## æ¦‚è¿°

æœ¬æ–‡æ¡£é›†åŒ…å« MariHydro ç‰©ç†å¼•æ“çš„å®Œæ•´é‡æ„è®¡åˆ’ï¼Œåˆ†ä¸º 7 ä¸ªé˜¶æ®µå®æ–½ï¼Œé¢„è®¡ 9 å‘¨å®Œæˆã€‚

## æ ¸å¿ƒé—®é¢˜è¯Šæ–­

| é—®é¢˜åŸŸ | ç°çŠ¶ | ä¸¥é‡ç¨‹åº¦ |
|--------|------|----------|
| Backendæ‚¬ç©º | traitå®šä¹‰å®Œå–„ä½†ä½¿ç”¨ç‡ä½ | ğŸ”´ Critical |
| ScalaråŒè½¨åˆ¶ | mh_foundationä¸mh_physicså„æœ‰å®šä¹‰ | ğŸ”´ Critical |
| é™æ€æ–¹æ³•é™·é˜± | Backendæ–¹æ³•æ— &selfï¼ŒGPUæ— æ³•æŒæœ‰è®¾å¤‡ | ğŸ”´ Critical |
| æ³¥æ²™æ¨¡å—æ–­è£‚ | åºŠå˜/æ‚¬æ²™/ç¤ºè¸ªå‰‚/å‚å‘æ— è€¦åˆ | ğŸŸ  High |
| åŠéšå¼éª¨æ¶åŒ– | Poissonæ±‚è§£å™¨ç¼ºå¤± | ğŸŸ  High |

## å…³é”®è®¾è®¡å†³ç­–

| å†³ç­–ç‚¹ | é€‰æ‹© | ç†ç”± |
|--------|------|------|
| Backendæ–¹æ³• | å®ä¾‹æ–¹æ³• | GPUéœ€æŒæœ‰CudaDevice/Stream |
| Scalarä½ç½® | åˆå¹¶åˆ°physics | å•ä¸€æƒå¨æºï¼Œfoundationé‡å¯¼å‡º |
| AIé›†æˆ | ç‹¬ç«‹Assimilable | AIä¸åº”æ±¡æŸ“ç‰©ç†æ ¸å¿ƒ |
| ç²¾åº¦æ§åˆ¶ | ç¼–è¯‘æœŸBackend | GPU kerneléœ€ç¼–è¯‘æœŸç¡®å®šç±»å‹ |

## æ–‡æ¡£ç»“æ„

```
refactoring/
â”œâ”€â”€ README.md                    # æœ¬æ–‡ä»¶ - æ€»è§ˆ
â”œâ”€â”€ phase0-cleanup.md            # Phase 0: æ¸…ç†ä¸æ ¹åŸº
â”œâ”€â”€ phase1-state-mesh.md         # Phase 1: çŠ¶æ€ä¸ç½‘æ ¼æ³›å‹åŒ–
â”œâ”€â”€ phase2-solver-strategy.md    # Phase 2: æ±‚è§£å™¨ç­–ç•¥åŒ–
â”œâ”€â”€ phase3-sources-tracer.md     # Phase 3: æºé¡¹ä¸ç¤ºè¸ªå‰‚æ³›å‹åŒ–
â”œâ”€â”€ phase4-sediment.md           # Phase 4: æ³¥æ²™ç³»ç»Ÿè€¦åˆ
â”œâ”€â”€ phase5-ai-agent.md           # Phase 5: AIä»£ç†å±‚
â”œâ”€â”€ phase6-gpu-prep.md           # Phase 6: GPUå‡†å¤‡
â””â”€â”€ phase7-testing.md            # Phase 7: æµ‹è¯•ä¸éªŒè¯
```

## å®æ–½æ—¶é—´çº¿

```
Week 1:  Phase 0 - æ¸…ç†ä¸æ ¹åŸº
Week 2:  Phase 1 - çŠ¶æ€ä¸ç½‘æ ¼æ³›å‹åŒ–
Week 3-4: Phase 2 - æ±‚è§£å™¨ç­–ç•¥åŒ–
Week 5:  Phase 3 - æºé¡¹ä¸ç¤ºè¸ªå‰‚æ³›å‹åŒ–
Week 6:  Phase 4 - æ³¥æ²™ç³»ç»Ÿè€¦åˆ
Week 7:  Phase 5 - AIä»£ç†å±‚
Week 8:  Phase 6 - GPUå‡†å¤‡
Week 9:  Phase 7 - æµ‹è¯•ä¸éªŒè¯
```

## ä»£ç æ”¹åŠ¨é‡ä¼°è®¡

| Phase | æ–°å»ºè¡Œæ•° | é‡æ„è¡Œæ•° | åˆ é™¤è¡Œæ•° | å‡€å˜åŒ– |
|-------|----------|----------|----------|--------|
| Phase 0 | 200 | 300 | 400 | +100 |
| Phase 1 | 100 | 600 | 200 | +500 |
| Phase 2 | 1500 | 800 | 300 | +2000 |
| Phase 3 | 400 | 500 | 100 | +800 |
| Phase 4 | 800 | 400 | 0 | +1200 |
| Phase 5 | 600 | 100 | 0 | +700 |
| Phase 6 | 300 | 0 | 0 | +300 |
| Phase 7 | 500 | 0 | 0 | +500 |
| **åˆè®¡** | **4400** | **2700** | **1000** | **+6100** |

## ç›®æ ‡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 0: åº”ç”¨å±‚ (mh_cli, mh_desktop)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: AIä»£ç†å±‚ (mh_agent) [æ–°å»º]                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚RemoteSensing â”‚ â”‚ Surrogate   â”‚ â”‚ DataAssim.  â”‚                     â”‚
â”‚  â”‚    Agent     â”‚ â”‚   Model     â”‚ â”‚   (EnKF)    â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚ Assimilable trait
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: ç‰©ç†å¼•æ“ (mh_physics)                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ engine/                                                          â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚ â”‚   Solver    â”‚â”€â”€â”‚TimeIntegration  â”‚â”€â”€â”‚   Workspace      â”‚      â”‚   â”‚
â”‚  â”‚ â”‚  (è°ƒåº¦å™¨)   â”‚  â”‚  Strategy<B>    â”‚  â”‚   <B: Backend>   â”‚      â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ sources/<B>   â”‚ â”‚ sediment/<B>   â”‚ â”‚ vertical/<B>            â”‚     â”‚
â”‚  â”‚ (æ‘©æ“¦/é£/...)  â”‚ â”‚ (SedimentMgr)  â”‚ â”‚ (ProfileRestorer)       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚ Backend trait
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: æ ¸å¿ƒæŠ½è±¡å±‚ (mh_physics/core)                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Backend    â”‚  â”‚  Scalar     â”‚  â”‚DeviceBuffer â”‚  â”‚ Dimension   â”‚   â”‚
â”‚  â”‚  (trait)    â”‚  â”‚  (trait)    â”‚  â”‚  (trait)    â”‚  â”‚ (D2/D3)     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ å®ç°: CpuBackend<f32/f64>, CudaBackend<f32/f64>  â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 4: åŸºç¡€è®¾æ–½ (mh_foundation, mh_mesh, mh_geo, mh_io)             â”‚
â”‚  - é‡å¯¼å‡ºcore::Scalar                                                   â”‚
â”‚  - ç½‘æ ¼æ‹“æ‰‘ã€åœ°ç†æŠ•å½±ã€IOé©±åŠ¨                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| æ³›å‹ç¼–è¯‘æ—¶é—´â†‘ | å¼€å‘æ•ˆç‡ | ä½¿ç”¨type aliaså‡å°‘æ³›å‹ä¼ æ’­æ·±åº¦ |
| f32ç²¾åº¦ä¸è¶³ | æ•°å€¼ç¨³å®šæ€§ | å…³é”®è·¯å¾„ï¼ˆå‹åŠ›Poissonï¼‰å¼ºåˆ¶f64 |
| PCGä¸æ”¶æ•› | åŠéšå¼å¤±è´¥ | é¢„æ¡ä»¶å™¨ + æ®‹å·®ç›‘æ§ + è‡ªåŠ¨å›é€€æ˜¾å¼ |
| AIåŒåŒ–ç ´åå®ˆæ’ | ç‰©ç†é”™è¯¯ | ConservationEnforcerå¼ºåˆ¶æ ¡éªŒ |
| GPUå†…å­˜æº¢å‡º | å¤§ç½‘æ ¼å¤±è´¥ | åˆ†å—å¤„ç† + åŠ¨æ€å†…å­˜æ±  |

## éªŒæ”¶æ ‡å‡†

1. æ‰€æœ‰ç°æœ‰æµ‹è¯•é€šè¿‡
2. f32/f64åç«¯ç»“æœå·®å¼‚ < 1e-3
3. æ˜¾å¼/åŠéšå¼ç­–ç•¥å¯è¿è¡Œæ—¶åˆ‡æ¢
4. æ³¥æ²™è´¨é‡å®ˆæ’è¯¯å·® < 1e-10
5. æºƒåæ ‡å‡†ç®—ä¾‹ L2è¯¯å·® < 1e-3
6. Thackerè§£æè§£æ”¶æ•›é˜¶ â‰¥ 1.5
